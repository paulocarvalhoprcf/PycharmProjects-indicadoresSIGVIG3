import csv
from datetime import datetime
from time import sleep

from tabulate import tabulate

operacao = int(input('''Qual o tipo de operação deseja pesquisar: exportação ou importação?
Digite [1] para exportação
Digite [2] para importação
Digite [3] para relatório geral por período\n'''))

usoPropostoVegetal = (
"produto vegetal para consumo direto", "embalagem e suportes de madeira", "material de pesquisa de origem vegetal",
"agente para controle biológico", "vinhos e derivados da uva e do vinho", "máquinas agrícolas",
"produto vegetal industrializado", "produto vegetal in natura", "agrotóxico", "material para propagação vegetal",
"fertilizante", "bebidas em geral", "corretivo", "inoculante")

usoPropostoAnimal = (
"animal vivo doméstico de companhia", "animal vivo para cria", "animal vivo para abate", "animal vivo para engorda",
"produto de origem animal comestível", "outros produtos destinados à alimentação animal",
"animal vivo para esporte", "animal vivo para exposição e espetáculo", "animal vivo para pesquisa",
"animal vivo para reprodução", "animal vivo para zoológico", "material de pesquisa de origem animal",
"material de multiplicação animal",
"produto de uso veterinário", "produto biológico", "produto de origem animal não comestível para industrialização",
"produto de origem animal não comestível para fins opoterápicos", "troféu de caça e taxidermia",
"produto de origem vegetal destinado à alimentação animal")

arquivo_1 = 'extracao_dados_pov.csv'
arquivo_2 = 'extracao_dados_impo_pov.csv'
arquivo_3 = 'extracao_dados_poa.csv'

if operacao == 1:

    area = int(input('''Qual área agropecuária deseja pesquisar?
Digite [1] para animal ou [2] para vegetal.\n'''))

    if area == 1:

        produto = input("Qual produto deseja pesquisar na base de dados?\n").lower()


        def buscaExportacaoAnimal(produto):

            tabela = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_3}'))
            c = 0
            p = 0
            for linha in tabela:
                c += 1
                mercadoria = linha[0]
                if produto in mercadoria.lower():
                    p += 1
            print(f"Este arquivo possui {c - 1} LPCOs.")
            if p > 0:
                print(f"Foram detectadas {p} LPCOs contendo a expressão '{produto}' na descrição da mercadoria.")
            else:
                print(f"O produto {produto} não foi encontrado na base de dados.")


        buscaExportacaoAnimal(produto)

    elif area == 2:

        menu = True

        while menu:

            tipoPesquisa = int(input('''Qual o tipo de pesquisa deseja fazer?
Digite [1] para pesquisar quantas LPCOs foram registradas na base de dados.
Digite [2] para pesquisar na base de dados por AFFA
Digite [3] para pesquisar por países de destino na base de dados.
Digite [4] para realizar pesquisas combinadas dos dois parâmetros anteriores.\n'''))

            if tipoPesquisa == 1:

                def buscaExportacaoPorQuantidade():

                    tabela = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_1}'))
                    c = 0

                    for linha in tabela:
                        c += 1

                    print(f"Este arquivo possui {c - 1} LPCOs de exportação.")


                buscaExportacaoPorQuantidade()

                pergunta = input("Deseja voltar ao menu inicial?\nDigite 'S' para voltar:\n").lower()

                sleep(1)

                if pergunta != 's':
                    menu = False

            elif tipoPesquisa == 2:

                qualFiscal = input("Qual AFFA deseja pesquisar na base de dados?\n").lower()


                def buscaExportacaoVegetalPorFiscal(fiscal):

                    tabela = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_1}'))
                    f = 0
                    nomeCompleto = ""

                    for linha in tabela:
                        dados = linha[3]
                        if fiscal in dados.lower():
                            f += 1
                            nomeCompleto = f"{dados}"

                    if f > 0:
                        print("Foram detectadas {} LPCOs deferidas pelo AFFA {}.".format(f, nomeCompleto))
                    else:
                        print("Não foram encontrados LPCOs deferidas pelo AFFA {} na base de dados.".format(fiscal))


                buscaExportacaoVegetalPorFiscal(qualFiscal)

                pergunta = input("Deseja voltar ao menu inicial?\nDigite 'S' para voltar:\n").lower()

                sleep(1)

                if pergunta != 's':
                    menu = False

            elif tipoPesquisa == 3:

                qualPais = input("Qual o país de destino deseja pesquisar na base de dados?\n").lower()


                def buscaExportacaoPorPais(pais):

                    tabela = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_1}'))
                    p = 0
                    nomePais = ""

                    for linha in tabela:
                        dados = linha[10]
                        if pais in dados.lower():
                            p += 1
                            nomePais = f"{dados}"

                    if p > 0:
                        print("Foram detectadas {} LPCOs contendo o país {} na descrição da mercadoria.".format(p,
                                                                                                                nomePais))
                    else:
                        print("O país de destino {} não foi encontrado na base de dados.".format(pais))


                buscaExportacaoPorPais(qualPais)

                sleep(1)

                pergunta = input("Deseja voltar ao menu inicial?\nDigite 'S' para voltar:\n").lower()

                if pergunta != 's':
                    menu = False

            elif tipoPesquisa == 4:

                qualFiscal = input("Qual AFFA deseja pesquisar na base de dados?\n").lower()
                qualPais = input("Qual destino deseja pesquisar na base de dados?\n").lower()


                def buscaExportacaoVegetalCombinada(fiscal, pais):

                    tabela = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_1}'))
                    n = 0
                    nomeCompleto = ""
                    nomePais = ""

                    for linha in tabela:
                        dados1 = linha[3]
                        dados2 = linha[10]
                        if fiscal in dados1.lower() and pais in dados2.lower():
                            n += 1
                            nomeCompleto = f"{dados1}"
                            nomePais = f"{dados2}"

                    if n > 0:
                        print(
                            "Foram detectadas {} LPCOs deferidas pelo AFFA {}, contendo coletivamente o país de destino {}.".format(
                                n, nomeCompleto, nomePais))
                    else:
                        print("Não foram encontradas combinações na base de dados.")


                buscaExportacaoVegetalCombinada(qualFiscal, qualPais)

                sleep(1)

                pergunta = input("Deseja voltar ao menu inicial?\nDigite 'S' para voltar:\n").lower()

                if pergunta != 's':
                    menu = False

elif operacao == 2:

    uso_proposto = int(input('''Qual área agropecuária deseja pesquisar?
Digite [1] para animal ou [2] para vegetal.\n'''))
    if uso_proposto == 1:
        for i in usoPropostoAnimal:
            print(f"{usoPropostoAnimal.index(i) + 1} - {i}")
        print("Qual dos usos propostos deseja pesquisar?")
        uso = usoPropostoAnimal[int(input()) - 1]
        print(uso)

    elif uso_proposto == 2:
        for i in usoPropostoVegetal:
            print(f"{usoPropostoVegetal.index(i) + 1} - {i}")
        print("Qual dos usos propostos deseja pesquisar?")
        uso = usoPropostoVegetal[int(input()) - 1]
        print(uso)

    produto = input("Qual produto deseja pesquisar na base de dados?\n").lower()


    def buscaImportacaoVegetal(produto):

        tabela = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_2}'))
        c = 0
        p = 0
        u = 0
        for linha in tabela:
            c += 1
            mercadoria = linha[0]
            if produto in mercadoria.lower():
                p += 1
            if uso in mercadoria.lower():
                u += 1
        print(f"Este arquivo possui {c - 1} LPCOs de importação.")
        if p > 0:
            print(f"Foram detectadas {p} LPCOs contendo {produto}.")
        else:
            print(f"O produto {produto} não foi encontrado na base de dados.")
        if u > 0:
            print(f"Foram encontradas {u} LPCOs contendo a expressão '{uso}' na descrição da mercadoria.")
        else:
            print(f"O uso proposto {uso} não foi encontrado na base de dados.")

    buscaImportacaoVegetal(produto)

elif operacao == 3:

# Utilizar data no formato dd/mm/aa
    dataInicio = input("Qual a data do início do período de pesquisa?\n")
    dataFim = input("Qual a data do final do período de pesquisa?\n")

    def buscaRelatorioTotalPorPeriodo(dataInicio, dataFim):

        minhaDataInicio = datetime.strptime(dataInicio, "%d/%m/%y")
        minhaDataFim = datetime.strptime(dataFim, "%d/%m/%y")

        tabela1 = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_3}'))
        nea = 0

        for linha in tabela1:
            if linha[5] != "Data de Recebimento":
                dataRecebimento = linha[5][0:8]
                minhaDataRecebimento = datetime.strptime(dataRecebimento, "%d/%m/%y")
                if minhaDataInicio <= minhaDataRecebimento <= minhaDataFim:
                    nea += 1

        tabela2 = csv.reader(open(f'/Users/pauloroberto/Desktop/{arquivo_1}'))
        nev = 0

        for linha in tabela2:
            if (linha[0].split(',')[5]) != '"Data de Recebimento"':
                dataRecebimento = linha[0].split(',')[5][1:9]
                minhaDataRecebimento = datetime.strptime(dataRecebimento, "%d/%m/%y")
                if minhaDataInicio <= minhaDataRecebimento <= minhaDataFim:
                    nev += 1

        tabela3 = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_2}'))
        nia = 0

        for linha in tabela3:
            if linha[24] != "Data de Recebimento":
                dataRecebimento = linha[24][0:8]
                minhaDataRecebimento = datetime.strptime(dataRecebimento, "%d/%m/%y")
                for i in usoPropostoAnimal:
                    if minhaDataInicio <= minhaDataRecebimento <= minhaDataFim and i in linha[11].lower():
                        nia += 1

        tabela3 = csv.reader(open(f'/Users/pauloroberto/Downloads/{arquivo_2}'))
        niv = 0

        for linha in tabela3:
            if linha[24] != "Data de Recebimento":
                dataRecebimento = linha[24][0:8]
                minhaDataRecebimento = datetime.strptime(dataRecebimento, "%d/%m/%y")
                for i in usoPropostoVegetal:
                    if minhaDataInicio <= minhaDataRecebimento <= minhaDataFim and i in linha[11].lower():
                        niv += 1

        tabelaFinal = [['Tipo de Operação','Número de LPCOs'], ['Exportação Animal',  nea],
                   ['Exportação Vegetal', nev], ['Importação Animal', nia], ['Importação Vegetal', niv]]

        print('----------------------------------------------------')
        print('---RELATÓRIO DE REGISTRO DE LPCO NA BASE DE DADOS---')
        print('----------------------------------------------------')
        print(f'Período requisitado: {dataInicio} a {dataFim}')
        print(tabulate(tabelaFinal, headers='firstrow', tablefmt='fancy_grid'))

    buscaRelatorioTotalPorPeriodo(dataInicio, dataFim)

    
